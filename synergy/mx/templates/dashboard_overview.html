{% extends 'main_header.html' %}
{% block body %}

<script type="text/javascript" src="{{ url_for('static', file='js/d3-5.14.2.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', file='js/d3-scale.v2.2.2.js') }}"></script>
<script type="text/javascript" src="{{ url_for('flow/static', file='js/dagre-d3-0.6.3.min.js') }}"></script>
<script type="text/javascript" src="{{ url_for('flow/static', file='js/flow_viewer.js') }}"></script>

<link rel="stylesheet" type="text/css" href="{{ url_for('static', file='css/composite-processing-chart.css') }}">
<script type="text/javascript" src="{{ url_for('static', file='js/composite-processing-chart.js') }}"></script>

<div class="page-title-bar">
    {% import 'block_enable_auto_refresh.html' as block_enable_refresh %}
    {{ block_enable_refresh.enable_auto_refresh() }}
</div>

<div class="container" >
    {% import 'block_time_window_selector.html' as block_time_window %}
    {{ block_time_window.time_window_selector(details, null) }}
</div>

<script type="text/javascript">
    $(function () {
        function getJobs() {
            const response_text = $.ajax({
                dataType: 'json',
                type: 'GET',
                url: '/jobs/',
                cache: false,
                async: false
            }).responseText;
            return JSON.parse(response_text);
         }

        function getTrees() {
            const response_text = $.ajax({
                data: {mx_page: null},
                dataType: 'json',
                type: 'GET',
                url: '/trees/',
                cache: false,
                async: false
            }).responseText;
            return JSON.parse(response_text);
        }

        const e = document.getElementById("time_window");
        const num_days = parseInt(e.options[e.selectedIndex].value);

        const jobs = {{ details.jobs|jsonify|safe }};
        {#const jobs = getJobs();#}
        const mx_trees = getTrees();

        // compute number of timperiods
        let datetimeUtcNow = new Date();
        let datetimeUtcStart = new Date(datetimeUtcNow);
        datetimeUtcStart.setUTCHours(-24 * num_days);   // winding time back by number of selected days
        datetimeUtcStart.setUTCHours(0, 0, 0, 0);       // setting time to midnight
        const num_timeperiods = Math.abs(datetimeUtcNow.getTime() - datetimeUtcStart.getTime()) / 3600000;

        let timeperiods = d3.range(num_timeperiods).map(function (i) {
            const datetime = new Date(datetimeUtcStart.getTime());
            datetime.setUTCHours(datetime.getUTCHours() + i);
            return dateToTimeperiod(datetime);
        });

        // Compile list of process names
        let processNames = [];
        for (const [mx_tree_name, tree_obj] of Object.entries(mx_trees)) {
            processNames = processNames.concat(tree_obj.sorted_process_names);
        }

        initChartDimensions(timeperiods.length, processNames.length);
        renderCompositeProcessingChart(processNames, timeperiods, jobs);
    });
</script>

{% endblock %}
